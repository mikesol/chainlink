version: '3.8'

services:
  # ============================================
  # Anvil Nodes (3-node cluster)
  # ============================================

  # Node 1 - Primary node
  node1:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: chainlink-node1
    entrypoint: anvil
    command: >
      --host 0.0.0.0
      --port 8545
      --chain-id ${CHAIN_ID:-31337}
      --accounts 10
      --balance 10000
      --mnemonic "${MNEMONIC:-test test test test test test test test test test test junk}"
      --block-time ${BLOCK_TIME:-2}
    ports:
      - "8545:8545"
    networks:
      - chainlink-network
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # Node 2
  node2:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: chainlink-node2
    entrypoint: anvil
    command: >
      --host 0.0.0.0
      --port 8545
      --chain-id ${CHAIN_ID:-31337}
      --accounts 10
      --balance 10000
      --mnemonic "${MNEMONIC:-test test test test test test test test test test test junk}"
      --block-time ${BLOCK_TIME:-2}
    ports:
      - "8546:8545"
    networks:
      - chainlink-network
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # Node 3
  node3:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: chainlink-node3
    entrypoint: anvil
    command: >
      --host 0.0.0.0
      --port 8545
      --chain-id ${CHAIN_ID:-31337}
      --accounts 10
      --balance 10000
      --mnemonic "${MNEMONIC:-test test test test test test test test test test test junk}"
      --block-time ${BLOCK_TIME:-2}
    ports:
      - "8547:8545"
    networks:
      - chainlink-network
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # ============================================
  # Gateway / Load Balancer
  # ============================================
  gateway:
    build: ./gateway
    container_name: chainlink-gateway
    ports:
      - "8540:80"
    depends_on:
      node1:
        condition: service_healthy
      node2:
        condition: service_healthy
      node3:
        condition: service_healthy
    networks:
      - chainlink-network
    restart: unless-stopped

  # ============================================
  # Auxiliary Services
  # ============================================

  # ETH Faucet
  faucet:
    build: ./services/faucet
    container_name: chainlink-faucet
    environment:
      - RPC_URL=http://node1:8545
      - FAUCET_PRIVATE_KEY=${FAUCET_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
      - DRIP_AMOUNT=${DRIP_AMOUNT:-1.0}
      - CHAIN_ID=${CHAIN_ID:-31337}
    ports:
      - "8550:8000"
    depends_on:
      node1:
        condition: service_healthy
    networks:
      - chainlink-network
    restart: unless-stopped

  # Cluster Status API
  status:
    build: ./services/status
    container_name: chainlink-status
    environment:
      - NODE1_URL=http://node1:8545
      - NODE2_URL=http://node2:8545
      - NODE3_URL=http://node3:8545
    ports:
      - "8551:8000"
    depends_on:
      node1:
        condition: service_healthy
      node2:
        condition: service_healthy
      node3:
        condition: service_healthy
    networks:
      - chainlink-network
    restart: unless-stopped

  # ============================================
  # Token Deployer (init container - runs once)
  # ============================================
  deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: chainlink-deployer
    volumes:
      - ./contracts:/contracts
    working_dir: /contracts
    entrypoint: sh
    command: >
      -c "
        echo 'Waiting for node1 to be ready...' &&
        sleep 5 &&
        echo 'Installing dependencies...' &&
        forge install OpenZeppelin/openzeppelin-contracts --no-commit 2>/dev/null || true &&
        echo 'Building contracts...' &&
        forge build &&
        echo 'Deploying ChainToken...' &&
        forge script script/Deploy.s.sol --rpc-url http://node1:8545 --broadcast --private-key ${DEPLOYER_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80} &&
        echo 'Deployment complete!'
      "
    depends_on:
      node1:
        condition: service_healthy
    networks:
      - chainlink-network

networks:
  chainlink-network:
    driver: bridge
    name: chainlink-network
